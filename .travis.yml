language: bash
dist: trusty
group: travis_latest
sudo: required

addons:
  apt:
    packages:
      - docker-ce

branches:
  only:
    - master

env:
  global:
    - BUILD_DATE="`date -u +%Y-%m-%dT%H:%M:%SZ`"
    - BUILD_NUMBER="$TRAVIS_BUILD_NUMBER"
    - DISTRIB_ID="`(docker pull stlouisn/ubuntu:rolling && docker run -it --rm stlouisn/ubuntu:rolling /bin/bash -c 'cat /etc/lsb-release') | grep DISTRIB_ID | awk -F '=' {'print $2'}`"
    - DISTRIB_RELEASE="`(docker pull stlouisn/ubuntu:rolling && docker run -it --rm stlouisn/ubuntu:rolling /bin/bash -c 'cat /etc/lsb-release') | grep DISTRIB_RELEASE | awk -F '=' {'print $2'}`"
    - DISTRIB_CODENAME="`(docker pull stlouisn/ubuntu:rolling && docker run -it --rm stlouisn/ubuntu:rolling /bin/bash -c 'cat /etc/lsb-release') | grep DISTRIB_CODENAME | awk -F '=' {'print $2'}`"
    - DOCKER_DESCRIPTION="network management software"
    - DOCKER_MAINTAINER="stlouisn"
    - DOCKER_NAME="unifi"
    - DOCKER_URL="https://community.ubnt.com/unifi/"
    - SCHEMA_VERSION="1.0"
    - VCS_REF="`git rev-parse --short HEAD`"
    - VCS_URL="`git remote get-url origin | head -c-5`"
    - UNIFI_TESTING="5.10"
    - UNIFI_STABLE="5.9"
    - UNIFI_LTS="5.6"
  matrix:
    - DOCKER_TAG="5.10"
      DOCKER_VERSION="5.10.12"
      DOWNLOAD_URL="https://dl.ubnt.com/unifi/5.10.12-20644d4901/UniFi.unix.zip"
    - DOCKER_TAG="5.9"
      DOCKER_VERSION="5.9.32"
      DOWNLOAD_URL="https://dl.ubnt.com/unifi/5.9.32-016da0b7c1/UniFi.unix.zip"
    - DOCKER_TAG="5.8"
      DOCKER_VERSION="5.8.30"
      DOWNLOAD_URL="https://dl.ubnt.com/unifi/5.8.30/UniFi.unix.zip"
    - DOCKER_TAG="5.7"
      DOCKER_VERSION="5.7.23"
      DOWNLOAD_URL="https://dl.ubnt.com/unifi/5.7.23/UniFi.unix.zip"
    - DOCKER_TAG="5.6"
      DOCKER_VERSION="5.6.40"
      DOWNLOAD_URL="https://dl.ubnt.com/unifi/5.6.40/UniFi.unix.zip"
    - DOCKER_TAG="5.5"
      DOCKER_VERSION="5.5.24"
      DOWNLOAD_URL="https://dl.ubnt.com/unifi/5.5.24/UniFi.unix.zip"

before_install:
  - docker version
  - sudo /sbin/sysctl -w net.ipv4.conf.all.forwarding=1

install:
  - mkdir -p ./userfs/usr/lib/unifi
  - curl -L $DOWNLOAD_URL -o ./unifi.zip
  - unzip ./unifi.zip
  - rm -rf ./UniFi/bin
  - rm -rf ./UniFi/lib/native/Mac
  - rm -rf ./UniFi/lib/native/Windows
  - rm -rf ./UniFi/readme.txt
  - mv ./UniFi -T ./userfs/usr/lib/unifi

before_script:
  - sed -i -e '/^$/d' -e 's/^[ \t]*//' -e '/^#/d' Dockerfile
  - chmod 0544 rootfs/usr/local/bin/*.sh

script:
  - >
    docker build
    --label org.label-schema.build-date="$BUILD_DATE"
    --label org.label-schema.build-number="$BUILD_NUMBER"
    --label org.label-schema.description="$DOCKER_DESCRIPTION"
    --label org.label-schema.maintainer="$DOCKER_MAINTAINER"
    --label org.label-schema.name="$DOCKER_NAME"
    --label org.label-schema.url="$DOCKER_URL"
    --label org.label-schema.version="$DOCKER_VERSION"
    --label org.label-schema.schema-version="$SCHEMA_VERSION"
    --label org.label-schema.vcs-ref="$VCS_REF"
    --label org.label-schema.vcs-url="$VCS_URL"
    --tag ${DOCKER_USERNAME}/${DOCKER_NAME}:${DOCKER_TAG}
    --pull .

after_success:
  - echo ${DOCKER_PASSWORD} | docker login --username ${DOCKER_USERNAME} --password-stdin
  - docker push ${DOCKER_USERNAME}/${DOCKER_NAME}:${DOCKER_TAG}
  - if [ "${DOCKER_TAG}" == "${UNIFI_TESTING}" ]; then
    docker tag ${DOCKER_USERNAME}/${DOCKER_NAME}:${DOCKER_TAG} ${DOCKER_USERNAME}/${DOCKER_NAME}:testing;
    docker push ${DOCKER_USERNAME}/${DOCKER_NAME}:testing;
    fi
  - if [ "${DOCKER_TAG}" == "${UNIFI_STABLE}" ]; then
    docker tag ${DOCKER_USERNAME}/${DOCKER_NAME}:${DOCKER_TAG} ${DOCKER_USERNAME}/${DOCKER_NAME}:stable;
    docker push ${DOCKER_USERNAME}/${DOCKER_NAME}:stable;
    fi
  - if [ "${DOCKER_TAG}" == "${UNIFI_LTS}" ]; then
    docker tag ${DOCKER_USERNAME}/${DOCKER_NAME}:${DOCKER_TAG} ${DOCKER_USERNAME}/${DOCKER_NAME}:lts;
    docker push ${DOCKER_USERNAME}/${DOCKER_NAME}:lts;
    fi

notifications:
  email:
    on_success: never
    on_failure: change
