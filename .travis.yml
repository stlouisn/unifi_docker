language: bash
dist: trusty
sudo: required

branches:
  only:
    - master

env:
  global:
    - BUILD_DATE="`date -u +%Y-%m-%dT%H:%M:%SZ`"
    - BUILD_NUMBER="${TRAVIS_BUILD_NUMBER}"
    - DOCKER_DESCRIPTION="wireless controller"
    - DOCKER_MAINTAINER="stlouisn"
    - DOCKER_NAME="unifi"
    - SCHEMA_VERSION="1.0"
    - VCS_REF="`git rev-parse --short HEAD`"
    - VCS_URL="`git remote get-url origin | head -c-5`"
  matrix:
    - DOCKER_TAG=LTS
      UNIFI_VERSION=`curl -SL https://help.ubnt.com/hc/en-us/articles/115000441548-UniFi-Current-Controller-Versions | grep "<td class" | grep "/a" | head -n 1 | awk -F ">" '{print $4}' | awk -F "<" '{print $1}'`
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/${UNIFI_VERSION)/UniFi.unix.zip
    - DOCKER_TAG=STABLE
      UNIFI_VERSION=5.5.24
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/5.5.24/UniFi.unix.zip
    - DOCKER_TAG=LATEST
      UNIFI_VERSION=5.6.18
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/5.6.18-8261dc5066/UniFi.unix.zip

before_install:
  - sudo apt-get update -q
  - sudo apt-get upgrade -q -y
  - docker version

install:
  - echo ${VERSION} > docker.rootfs/${NAME}_version
  - chmod 0744 docker.rootfs/usr/local/bin/docker_entrypoint.sh

after_install:
  - export VERSION=`echo ${VERSION} | awk -F "-" '{print $1}'`

before_script:
  - if [ "${TRAVIS_BRANCH}" == "master" ]; then
      export DOCKER_TAG="latest";
    else
      export DOCKER_TAG="${TRAVIS_BRANCH}";
    fi
  - sed -i -e '/^$/d' -e 's/^[ \t]*//' -e '/^#/d' Dockerfile

script:
  - >
    docker build
    --label org.label-schema.build-date=${BUILD_DATE}
    --label org.label-schema.build-number=${BUILD_NUMBER}
    --label org.label-schema.description="${DOCKER_DESCRIPTION}"
    --label org.label-schema.maintainer=${DOCKER_MAINTAINER}
    --label org.label-schema.name=${DOCKER_NAME}
    --label org.label-schema.schema-version=${SCHEMA_VERSION}
    --label org.label-schema.url=${DOCKER_URL}
    --label org.label-schema.vcs-ref=${VCS_REF}
    --label org.label-schema.vcs-url=${VCS_URL}
    --label org.label-schema.version=${VERSION}
    --tag ${DOCKER_USERNAME}/${DOCKER_IMAGE}:${DOCKER_TAG} .

after_success:
  - echo ${DOCKER_PASSWORD} | docker login --username ${DOCKER_USERNAME} --password-stdin
  - docker push ${DOCKER_USERNAME}/${DOCKER_IMAGE}:${DOCKER_TAG}

notifications:
  email:
    on_success: never
    on_failure: change
