language: bash
dist: trusty
sudo: required

branches:
  only:
    - master

env:
  global:
    - BUILD_DATE="`date -u +%Y-%m-%dT%H:%M:%SZ`"
    - BUILD_NUMBER="${TRAVIS_BUILD_NUMBER}"
    - DOCKER_DESCRIPTION="wireless controller"
    - DOCKER_MAINTAINER="stlouisn"
    - DOCKER_NAME="unifi"
    - SCHEMA_VERSION="1.0"
    - URL="https://community.ubnt.com/unifi"
    - VCS_REF="`git rev-parse --short HEAD`"
    - VCS_URL="`git remote get-url origin | head -c-5`"
  matrix:
    - DOCKER_TAG=latest
      DOCKER_VERSION=5.6.29
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/5.6.29-445c8ce6c7/UniFi.unix.zip
    - DOCKER_TAG=stable
      DOCKER_VERSION=5.6.26
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/5.6.26/UniFi.unix.zip
    - DOCKER_TAG=5.4
      DOCKER_VERSION=5.4.19
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/5.4.19/UniFi.unix.zip
    - DOCKER_TAG=5.5
      DOCKER_VERSION=5.5.27
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/5.5.27-b56dba9184/UniFi.unix.zip
    - DOCKER_TAG=5.6
      DOCKER_VERSION=5.6.29
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/5.6.29-445c8ce6c7/UniFi.unix.zip
    - DOCKER_TAG=5.7
      DOCKER_VERSION=5.7.10
      UNIFI_DOWNLOAD=https://dl.ubnt.com/unifi/5.7.10-581a7e9158/UniFi.unix.zip

before_install:
  - sudo apt-get update -q
  - sudo apt-get upgrade -q -y
  - docker version

install:
  - chmod 0744 rootfs/usr/local/bin/docker_entrypoint.sh

before_script:
  - sed -i -e '/^$/d' -e 's/^[ \t]*//' -e '/^#/d' Dockerfile

script:
  - >
    docker build
    --build-arg UNIFI_DOWNLOAD="${UNIFI_DOWNLOAD}"
    --label org.label-schema.build-date="${BUILD_DATE}"
    --label org.label-schema.build-number="${BUILD_NUMBER}"
    --label org.label-schema.description="${DOCKER_DESCRIPTION}"
    --label org.label-schema.maintainer="${DOCKER_MAINTAINER}"
    --label org.label-schema.name="${DOCKER_NAME}"
    --label org.label-schema.schema-version="${SCHEMA_VERSION}"
    --label org.label-schema.url="${URL}"
    --label org.label-schema.vcs-ref="${VCS_REF}"
    --label org.label-schema.vcs-url="${VCS_URL}"
    --label org.label-schema.version="${DOCKER_VERSION}"
    --tag ${DOCKER_USERNAME}/${DOCKER_NAME}:${DOCKER_TAG}
    --pull .

after_success:
  - echo ${DOCKER_PASSWORD} | docker login --username ${DOCKER_USERNAME} --password-stdin
  - docker push ${DOCKER_USERNAME}/${DOCKER_NAME}:${DOCKER_TAG}

notifications:
  email:
    on_success: never
    on_failure: change
